# Migration Job for Bid Service using Goose
# Goose manages idempotency via the goose_db_version table - 
# it tracks which migrations have run and only executes new ones.
apiVersion: batch/v1
kind: Job
metadata:
  name: bid-service-migrate
  labels:
    app: bid-service
    component: migration
spec:
  ttlSecondsAfterFinished: 300  # Clean up after 5 minutes
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: bid-service
        component: migration
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z postgres-bids-postgresql 5432; do echo "Waiting for PostgreSQL..."; sleep 2; done']
      containers:
        - name: migrate
          image: bid-service  # Uses the same image that Tilt builds
          command:
            - /app/goose
            - -dir
            - /app/migrations
            - postgres
            - "$(DATABASE_URL)"
            - up
          env:
            - name: DATABASE_URL
              value: "postgres://user:password@postgres-bids-postgresql:5432/bid_db?sslmode=disable"
