---
alwaysApply: true
always_on: true
trigger: always_on
applyTo: "**"
description: Project Guidelines
---

# Project Architecture & Patterns

## Core Philosophy
This project uses a simplified **Hexagonal Architecture (Ports & Adapters)** to decouple business logic from infrastructure. The goal is to ensure the "Core Domain" remains pure and testable, while "Infrastructure" implements the specific details (Postgres, RabbitMQ, etc.).

## Directory Structure
- `internal/auction/`: **The Core Domain**. Contains pure Go logic.
  - `models.go`: Domain entities (e.g., `Bid`, `Item`). No SQL or JSON tags.
  - `ports.go`: Interfaces defining external needs (e.g., `BidRepository`, `EventPublisher`).
  - `service.go`: Business logic implementing the use cases.
- `internal/infra/`: **Adapters**. Implements the interfaces defined in Core.
  - `database/`: Postgres implementation using raw `pgx`.
  - `events/`: RabbitMQ implementation.
- `internal/api/`: **Driving Adapters**. Handles HTTP requests.
  - Defines DTOs (Data Transfer Objects) for JSON marshalling.
  - Maps DTOs to Domain Models before calling the Service.

## Technology Decisions

### 1. Database Access: Raw `pgx`
- **Decision:** Use `github.com/jackc/pgx/v5` directly.
- **Why:** To maintain full control over SQL execution, transactions, and locking mechanisms (critical for concurrency).
- **Avoid:** Heavy ORMs (GORM, Ent) or excessive abstraction layers.

### 2. Transaction Management
- The Service layer orchestrates transactions when necessary (e.g., Outbox Pattern).
- Use `pgx.Tx` for atomic operations involving both state changes and event persistence.

### 3. API & DTOs
- **Separation:** API handlers use specific Request/Response structs (DTOs).
- **Mapping:** Handlers explicitly map between DTOs and Domain Models.
- **Validation:** Basic validation happens in the Handler (DTOs); business rule validation happens in the Service.

### 4. Event-Driven Architecture
- **Pattern:** Transactional Outbox.
- **Rule:** Never publish to the Message Queue directly from a Service transaction.
- **Flow:** Service saves `Event` to DB table within the transaction -> Background Worker relays to RabbitMQ.

## Code Conventions
- **Interfaces:** Define interfaces in the package where they are *used* (Consumer-driven), typically `internal/auction/ports.go`.
- **Errors:** Use typed errors in the Domain layer. Map them to HTTP status codes in the API layer.
- **Testing:** Unit test the Service by mocking the Repository interface. Integration test the Repository with `testcontainers`.

